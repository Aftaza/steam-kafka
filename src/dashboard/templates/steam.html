<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Steam Game Monitor Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <style>
      * { box-sizing: border-box; }
      body { 
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; 
        margin: 0; 
        background: linear-gradient(135deg, #1b2838 0%, #2a475e 100%);
        color: #c7d5e0;
        min-height: 100vh;
      }
      header { 
        padding: 20px 30px; 
        border-bottom: 2px solid #1e3a52;
        background: rgba(27, 40, 56, 0.95);
        position: sticky; 
        top: 0;
        backdrop-filter: blur(10px);
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      }
      h1 { 
        font-size: 24px; 
        margin: 0; 
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      nav {
        margin-top: 15px;
        display: flex;
        gap: 15px;
      }
      nav a {
        color: #66c0f4;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 4px;
        background: rgba(102, 192, 244, 0.1);
        transition: all 0.3s;
        font-weight: 600;
      }
      nav a:hover {
        background: rgba(102, 192, 244, 0.2);
        transform: translateY(-2px);
      }
      nav a.active {
        background: #66c0f4;
        color: #1b2838;
      }
      main { 
        padding: 30px; 
        max-width: 1400px;
        margin: 0 auto;
      }
      .section-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: rgba(22, 34, 48, 0.8);
        border: 1px solid #2a475e;
        border-radius: 12px;
        padding: 20px;
        transition: transform 0.3s, box-shadow 0.3;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      }
      .stat-label {
        color: #8f98a0;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }
      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #66c0f4;
      }
      .stat-subtitle {
        color: #acb2b8;
        font-size: 14px;
        margin-top: 5px;
      }
      .games-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .game-card {
        background: rgba(22, 34, 48, 0.9);
        border: 1px solid #2a475e;
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
      }
      .game-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        border-color: #66c0f4;
      }
      .game-header-img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        background: linear-gradient(135deg, #1e3a52, #2a475e);
      }
      .game-content {
        padding: 20px;
      }
      .game-title {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 10px 0;
        color: #fff;
      }
      .game-title a {
        color: #fff;
        text-decoration: none;
      }
      .game-title a:hover {
        color: #66c0f4;
      }
      .price-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
      }
      .discount-badge {
        background: #4c6b22;
        color: #beee11;
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: 700;
        font-size: 14px;
      }
      .original-price {
        text-decoration: line-through;
        color: #738895;
        font-size: 14px;
      }
      .final-price {
        font-size: 20px;
        font-weight: 700;
        color: #beee11;
      }
      .free-badge {
        background: #5c7e10;
        color: #beee11;
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: 700;
        font-size: 16px;
      }
      .game-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }
      .meta-tag {
        background: rgba(102, 192, 244, 0.15);
        color: #66c0f4;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
      }
      .rating {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
        font-size: 14px;
      }
      .rating-score {
        color: #beee11;
        font-weight: 700;
      }
      .player-count {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #66c0f4;
        font-weight: 600;
        margin-top: 8px;
      }
      .chart-container {
        background: rgba(22, 34, 48, 0.8);
        border: 1px solid #2a475e;
        border-radius: 12px;
        padding: 25px;
        margin-top: 20px;
      }
      canvas {
        max-height: 400px;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #8f98a0;
        font-size: 16px;
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #8f98a0;
      }
      .empty-state h3 {
        color: #fff;
        margin-bottom: 10px;
      }
      footer {
        padding: 20px 30px;
        color: #8f98a0;
        font-size: 13px;
        border-top: 1px solid #1e3a52;
        text-align: center;
        background: rgba(27, 40, 56, 0.7);
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>üéÆ Steam Game Monitor</h1>
      <nav>
        <a href="/steam" class="active">Steam Games</a>
        <a href="/games">Game Manager</a>
      </nav>
    </header>
    
    <main>
      <!-- Monitored Games (Watchlist) -->
      <section>
        <div class="section-title">üßø Monitored Games
          <span style="margin-left:10px; font-size: 13px; color:#8f98a0; font-weight:600">(Manage additions in Game Manager)</span>
        </div>
        <div id="watchlist" class="games-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
          <div class="loading">Loading watchlist‚Ä¶</div>
        </div>
      </section>

      <!-- Summary Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Games Monitored</div>
          <div class="stat-value" id="gameCount">‚Äî</div>
          <div class="stat-subtitle" id="lastUpdate">Loading...</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Active Discounts</div>
          <div class="stat-value" id="discountCount">‚Äî</div>
          <div class="stat-subtitle">currently on sale</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Players</div>
          <div class="stat-value" id="totalPlayers">‚Äî</div>
          <div class="stat-subtitle" id="playerGames">across monitored games</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Best Discount</div>
          <div class="stat-value" id="bestDiscount">‚Äî</div>
          <div class="stat-subtitle" id="bestDiscountGame">‚Äî</div>
        </div>
      </div>

      <!-- Games on Discount -->
      <section id="discountsSection" style="display: none;">
        <div class="section-title">üî• Games on Sale</div>
        <div class="games-grid" id="discountGames"></div>
      </section>

      <!-- All Games -->
      <section>
        <div class="section-title">üìö All Monitored Games</div>
        <div class="games-grid" id="allGames">
          <div class="loading">Loading games data...</div>
        </div>
      </section>

      <!-- Player Stats Chart -->
      <section id="playerStatsSection" style="display: none;">
        <div class="section-title">üìä Player Statistics</div>
        <div class="chart-container">
          <canvas id="playerChart"></canvas>
        </div>
      </section>
    </main>

    <footer>
      Steam Game Monitor ‚Ä¢ Powered by Spark Structured Streaming ‚Ä¢ Real-time price tracking & notifications
    </footer>

    <script>
      const fmtNumber = (n) => n ? n.toLocaleString() : '‚Äî';
      const fmtTime = (ts) => new Date(ts * 1000).toLocaleString();

      let playerChart = null;

      function renderGameCard(game, showDiscount = false) {
        const { app_id, name, header_image, is_free, initial_price, final_price, 
                discount_percent, on_sale, genres = [], metacritic_score, 
                total_recommendations, current_players, release_date } = game;
        
        let priceHtml = '';
        if (is_free) {
          priceHtml = '<div class="free-badge">FREE TO PLAY</div>';
        } else if (on_sale && discount_percent > 0) {
          priceHtml = `
            <div class="price-row">
              <span class="discount-badge">-${discount_percent}%</span>
              <span class="original-price">$${initial_price.toFixed(2)}</span>
              <span class="final-price">$${final_price.toFixed(2)}</span>
            </div>
          `;
        } else {
          priceHtml = `<div class="final-price">$${final_price.toFixed(2)}</div>`;
        }

        const genreTags = genres.slice(0, 3).map(g => 
          `<span class="meta-tag">${g}</span>`
        ).join('');

        const ratingHtml = metacritic_score 
          ? `<div class="rating">üèÜ Metacritic: <span class="rating-score">${metacritic_score}</span></div>`
          : total_recommendations > 0 
            ? `<div class="rating">üëç ${fmtNumber(total_recommendations)} recommendations</div>`
            : '';

        const playersHtml = current_players 
          ? `<div class="player-count">üë• ${fmtNumber(current_players)} playing now</div>`
          : '';

        return `
          <div class="game-card">
            ${header_image ? `<img src="${header_image}" class="game-header-img" alt="${name}" />` : ''}
            <div class="game-content">
              <h3 class="game-title">
                <a href="https://store.steampowered.com/app/${app_id}" target="_blank">${name}</a>
              </h3>
              ${priceHtml}
              <div class="game-meta">
                ${genreTags}
                <span class="meta-tag">üìÖ ${release_date}</span>
              </div>
              ${ratingHtml}
              ${playersHtml}
            </div>
          </div>
        `;
      }

      async function fetchData() {
        try {
          const [gamesRes, playersRes, discountsRes] = await Promise.all([
            fetch('/api/steam/games'),
            fetch('/api/steam/players'),
            fetch('/api/steam/discounts')
          ]);

          const gamesData = await gamesRes.json();
          const playersData = await playersRes.json();
          const discountsData = await discountsRes.json();

          updateStats(gamesData, playersData, discountsData);
          renderGames(gamesData.games || []);
          renderDiscounts(discountsData.discounts || []);
          renderPlayerChart(playersData.games || []);

        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }

      async function fetchWatchlist() {
        const container = document.getElementById('watchlist');
        container.innerHTML = '<div class="loading">Loading watchlist‚Ä¶</div>';
        try {
          const res = await fetch('/api/games/watchlist');
          const data = await res.json();
          const ids = (data.games || []).map(Number);
          const info = data.game_info || {};

          if (!ids.length) {
            container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1"><h3>No monitored games</h3><p>Add games from the <a href="/games">Game Manager</a></p></div>';
            return;
          }

          // Build simple cards with remove buttons
          container.innerHTML = ids.map(id => {
            const name = info[id] || info[String(id)] || `App ${id}`;
            return `
              <div class="game-card" style="padding:16px">
                <div class="game-content" style="padding:0">
                  <h3 class="game-title" style="margin-bottom:8px">
                    <a href="https://store.steampowered.com/app/${id}" target="_blank">${name}</a>
                  </h3>
                  <div style="display:flex; gap:10px; align-items:center; justify-content:space-between">
                    <span class="meta-tag">App ID: ${id}</span>
                    <button class="btn-remove" onclick="removeMonitored(${id})" style="cursor:pointer; background:#8b2e2e; color:#ffb3b3; border:1px solid #b24a4a; padding:6px 10px; border-radius:6px; font-weight:700">Remove</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        } catch (e) {
          console.error('Failed to load watchlist', e);
          container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1">Failed to load watchlist</div>';
        }
      }

      async function removeMonitored(appId) {
        if (!confirm('Remove this game from the watchlist?')) return;
        try {
          const res = await fetch(`/api/games/watchlist/${appId}`, { method: 'DELETE' });
          const result = await res.json();
          if (result.success) {
            await Promise.all([fetchWatchlist(), fetchData()]);
          } else {
            alert('Failed to remove: ' + (result.error || 'unknown error'));
          }
        } catch (e) {
          alert('Failed to remove game');
        }
      }

      function updateStats(games, players, discounts) {
        document.getElementById('gameCount').textContent = games.game_count || 0;
        document.getElementById('lastUpdate').textContent = games.updated_at 
          ? 'Updated: ' + fmtTime(games.updated_at) 
          : 'No data yet';

        document.getElementById('discountCount').textContent = discounts.discount_count || 0;
        document.getElementById('totalPlayers').textContent = fmtNumber(players.total_players || 0);
        document.getElementById('playerGames').textContent = `across ${players.total_games || 0} games`;

        // Best discount
        const bestDeal = discounts.discounts?.[0];
        if (bestDeal) {
          document.getElementById('bestDiscount').textContent = `-${bestDeal.discount_percent}%`;
          document.getElementById('bestDiscountGame').textContent = bestDeal.name;
        }
      }

      function renderGames(games) {
        const container = document.getElementById('allGames');
        if (!games.length) {
          container.innerHTML = '<div class="empty-state"><h3>No games yet</h3><p>Add games to your watchlist</p></div>';
          return;
        }

        container.innerHTML = games.map(g => renderGameCard(g)).join('');
      }

      function renderDiscounts(discounts) {
        const section = document.getElementById('discountsSection');
        const container = document.getElementById('discountGames');
        
        if (!discounts.length) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';
        container.innerHTML = discounts.map(g => renderGameCard(g, true)).join('');
      }

      function renderPlayerChart(games) {
        if (!games.length) {
          document.getElementById('playerStatsSection').style.display = 'none';
          return;
        }

        document.getElementById('playerStatsSection').style.display = 'block';

        const sortedGames = games.slice().sort((a, b) => b.current_players - a.current_players).slice(0, 10);
        const labels = sortedGames.map(g => g.name.length > 30 ? g.name.substring(0, 30) + '...' : g.name);
        const data = sortedGames.map(g => g.current_players);

        const ctx = document.getElementById('playerChart');
        
        if (playerChart) {
          playerChart.destroy();
        }

        playerChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Current Players',
              data: data,
              backgroundColor: 'rgba(102, 192, 244, 0.8)',
              borderColor: 'rgba(102, 192, 244, 1)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { 
                display: false 
              },
              title: {
                display: true,
                text: 'Top 10 Games by Current Players',
                color: '#fff',
                font: { size: 16 }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: '#8f98a0' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: '#8f98a0' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
      }

      // Initial load
      fetchData();
      fetchWatchlist();

      // Auto-refresh every 30 seconds
      setInterval(() => { fetchData(); fetchWatchlist(); }, 30000);
    </script>
  </body>
</html>
